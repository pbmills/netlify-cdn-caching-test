---
import { fetchData } from '../js/fetchData';

// This page fetches data from a free API that can be slow
// The data will be cached using in-memory cache (like special olympics)

interface Country {
  name: {
    common: string;
    official: string;
  };
  capital: string[];
  population: number;
  region: string;
  subregion: string;
  flags: {
    png: string;
  };
}

let countries: Country[] = [];
let loadTime = 0;
let isCached = false;
let error: string | null = null;
let isLocalDev = false;

// Check if running locally
const requestHeaders = Astro.request.headers;
const host = requestHeaders.get('host') || '';
isLocalDev = host.includes('localhost') || host.includes('127.0.0.1') || import.meta.env.DEV;

// Track total page generation time to detect CDN cache
const pageStartTime = Date.now();

try {
  const apiUrl = 'https://restcountries.com/v3.1/all?fields=name,capital,population,region,subregion,flags';
  
  // Use the same caching system as special olympics
  // This caches the API response in-memory (within the serverless function)
  const result = await fetchData(apiUrl, {
    headers: {
      'Accept': 'application/json',
    },
  });
  
  countries = result.data;
  loadTime = result.loadTime;
  
  // Calculate total page generation time
  const totalPageTime = Date.now() - pageStartTime;
  
  if (isLocalDev) {
    // Local dev: Only in-memory cache works (no CDN)
    // CDN caching only works when deployed to Netlify
    isCached = result.fromCache; // Only shows in-memory cache status
  } else {
    // Production: Check for CDN cache or in-memory cache
    // Determine cache status:
    // - If total page time is very fast (< 100ms), likely served from CDN cache (page wasn't regenerated)
    // - If API was cached but page took longer, it's in-memory cache (function ran but API was cached)
    // - If both are slow, it's a fresh request
    if (totalPageTime < 100) {
      // Very fast = CDN cached the entire HTML page
      isCached = true;
      loadTime = totalPageTime;
    } else if (result.fromCache) {
      // API was cached in-memory, but page was regenerated
      isCached = true;
    } else {
      // Fresh request - nothing cached
      isCached = false;
    }
  }
  
  // Sort by population descending
  countries.sort((a, b) => b.population - a.population);
  
} catch (err) {
  error = err instanceof Error ? err.message : 'Unknown error occurred';
  isCached = false;
}

// Set cache headers for Netlify CDN (like special olympics)
// This tells Netlify to cache the HTML page for 1 hour
// Note: This only works when deployed to Netlify, not in local dev
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, stale-while-revalidate=86400');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Netlify CDN Caching Demo" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Netlify CDN Caching Demo</title>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-primary-500 via-primary-600 to-purple-600 p-4 md:p-8 text-gray-800">
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-8 md:p-12">
      <div class="text-center mb-8">
        {error ? (
          <div class="bg-red-100 text-red-800 p-4 rounded-lg border-l-4 border-red-500">
            <strong>Error:</strong> {error}
          </div>
        ) : (
          <>
            {isLocalDev && (
              <div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg mb-4 text-sm">
                ⚠️ Local Dev: Only in-memory cache works. CDN caching only works when deployed to Netlify.
              </div>
            )}
            <h1 class={`text-4xl md:text-6xl font-bold mb-6 ${
              isCached ? 'text-green-600' : 'text-amber-600'
            }`}>
              {isCached ? 'Cached' : 'Not Cached'}
            </h1>
            <div class="text-3xl md:text-5xl font-bold text-gray-800 mb-2">
              {loadTime}ms
            </div>
            {isLocalDev && (
              <div class="text-sm text-gray-600">
                (In-memory cache only)
              </div>
            )}
          </>
        )}
      </div>

      {countries.length > 0 && (
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 px-4 py-2 text-left">Flag</th>
                <th class="border border-gray-300 px-4 py-2 text-left">Country</th>
                <th class="border border-gray-300 px-4 py-2 text-left">Capital</th>
                <th class="border border-gray-300 px-4 py-2 text-left">Region</th>
                <th class="border border-gray-300 px-4 py-2 text-right">Population</th>
              </tr>
            </thead>
            <tbody>
              {countries.map((country) => (
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-4 py-2">
                    {country.flags?.png && (
                      <img 
                        src={country.flags.png} 
                        alt={country.name.common}
                        class="w-12 h-8 object-cover"
                        loading="lazy"
                      />
                    )}
                  </td>
                  <td class="border border-gray-300 px-4 py-2 font-medium">{country.name.common}</td>
                  <td class="border border-gray-300 px-4 py-2">{country.capital?.[0] || '-'}</td>
                  <td class="border border-gray-300 px-4 py-2">{country.region}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right">{country.population.toLocaleString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  </body>
</html>